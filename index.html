<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>SVG Watches</title>
    <style>
    html, body{
        margin: 0;
        padding: 0;
    }
    body{
        background: #dddddd;
        overflow: hidden;
        cursor: default;
    }
    </style>
    <link rel="apple-touch-icon" href="icon.png"/>
</head>
<body>
<svg xmlns="http://www.w3.org/2000/svg" version="1.1"
        viewBox="0 0 1000 1000"
        preserveAspectRatio="xMidYMid meet" id="svg">
    <defs>
        <filter id="drop-shadow"> 
            <feGaussianBlur in="SourceAlpha" stdDeviation="2" result="blur"/>
            <feOffset in="blur" dx="1" dy="0" result="offsetBlur"/>
            <feMerge>
                <feMergeNode in="offsetBlur"/>
                <feMergeNode in="SourceGraphic"/>
            </feMerge>
        </filter>
        <style type="text/css"><![CDATA[
        .arrows { 
            fill: #eee; 
            filter: url(#drop-shadow);
        }
        .seconds{
            fill: red;
        }
        .mark, .smallmark{
        
        }
        ]]></style>
    </defs>
    <circle id="clearButton" cx="900" cy="100" r="50" fill="#777" />
    <g transform="translate(500, 500)">
        <g id="clockface">
            <circle cx="0" cy="0" r="494" stroke="#000" fill="#222" stroke-width="6" />
            <g id="clockmarkslive" fill="#eee"></g>
            <g id="hours">
                <rect class="arrows" x="-100" y="-15" width="350" height="30"></rect>
            </g>
            <g id="minutes">
                <rect class="arrows" x="-100" y="-15" width="480" height="30"></rect>
            </g>
            <g id="seconds" class="arrows seconds" mask="url(#center)">
                <rect x="-100" y="-5" width="490" height="10" transform="rotate(0)"></rect>
                <circle cx="0" cy="0" r="13"/>
                <circle cx="0" cy="0" r="5" fill="#eee" stroke-width="3" stroke="#444" />
            </g>
            <g id="speedTimeBlock" display="none">
                <circle cx="0" cy="0" r="200" fill="#777" />
                <text id="speedTime" x="0" y="40" font-size="140" fill="#eee" text-anchor="middle"></text>
            </g>
        </g>
        <g transform="translate(-400, -235)">
            <foreignObject id="eventPrompt" width="800" height="470" display="none">
                <body xmlns="http://www.w3.org/1999/xhtml">
                    <style type="text/css">
                        .info-popup{
                            padding: 30px 30px;
                            background: #eee;
                            border-radius: 14px;
                            border: 8px solid #999;
                        }
                        .form-input{
                            padding: 8px;
                            width: 706px;
                            border: 1px solid #999;
                            border-radius: 5px;
                            background: #efefef;
                        }
                        .text{
                            color: #222;
                            font-size: 70px;
                            font-family: Georgia, Verdana;
                        }
                        .block{
                            margin-bottom:10px;
                        }
                        .button{
                            padding: 24px 20px;
                            width: 350px;
                            font-size: 50px;
                        }
                        .refuse-button{
                            color: #777;
                        }
                        .time{
                            font-size: 50px;
                            font-weight: bold;
                        }
                    </style>
                    <div class="info-popup">
                        <form id="eventForm" method="post" action="">
                            <div id="setTime" class="time block"></div>
                            <div class="block input-block">
                                <textarea id="eventName" class="form-input text" rows="2" placeholder="Wazzap!"></textarea>
                            </div>
                            <table width="100%">
                                <tr>
                                    <td align="left">
                                        <input id="eventButtonRemove" type="button" class="text button refuse-button" name="remove" value="Remove">
                                    </td>
                                    <td align="right">
                                        <input id="eventButtonSet" type="submit" class="text button" name="submit" value="Set">
                                    </td>
                                </tr>
                            </table>
                        </form>
                    </div>
                </body>
            </foreignObject>
        </g>
    </g>
    <script type="application/ecmascript"><![CDATA[
        window.onload = function(){
            var clock = new Clock();
            clock.start();
        }
        
        /****************************************************/
        
        function Mark(id){
            this.update = new Date();
            this.time = new Date();
            
            if (id !== null){
                this.find(id);
            }
        }
        
        Mark.prototype = {
            id: null,
        
            checked: false,
            
            title: '',
            
            time: 0,
            
            update: 0,
            
            find: function(id){
                this.reset();
                this.id = id;
                
                var data = localStorage.getItem(id);
                if (data !== null){
                    data = JSON.parse(data);
                    if (typeof data == 'object'){
                        if (data.checked !== null) this.checked = data.checked;
                        if (data.title !== null) this.title = data.title;
                        if (data.update !== null) this.update = new Date(data.update);
                        if (data.time !== null) this.time = new Date(data.time);
                    }
                }
            },
            
            reset: function(){
                this.id = null;
                this.checked = false;
                this.title = '';
                this.time = new Date();
            },
            
            remove: function(){
                localStorage.removeItem(this.id);
                this.reset();
            },
            
            save: function(){
                this.update = new Date();
                
                var data = {
                    checked: this.checked,
                    title: this.title,
                    update: this.update.getTime(),
                    time: this.time.getTime()
                };
                
                localStorage.setItem(this.id, JSON.stringify(data));
            }
        }
        
        /****************************************************/
        
        function Angle(angle){
            this.angle = angle;
        }
        
        Angle.prototype = {
            angle: 0,

            get: function(){
                return this.angle;
            },
            
            set: function(angle){
                angle += "";
                this.angle = angle * 1;
            },
            
            add: function(angle){
                angle += "";
                this.angle += angle * 1;
            },
            
            normalize: function(){
                this.angle = this.normalized();
            },
            
            normalized: function(){
                var angle = this.angle;
                if (angle < 0) angle = 360 + angle % 360;
                if (angle >= 360) angle = angle % 360;
                
                return angle;
            },
            
            distance: function(angle){
                if (typeof angle !== "object") angle = new Angle(angle);

                var calcAngle = this.normalized() - angle.normalized();
                var isPositive = false;

                if (calcAngle >= 0){
                    isPositive = calcAngle <= 300;
                    if (!isPositive) calcAngle = 360 - calcAngle;
                } else {
                    isPositive = -calcAngle > 60;
                    if (isPositive) calcAngle += 360;
                }
                
                calcAngle = Math.abs(calcAngle);

                return new Angle(isPositive ? calcAngle : -calcAngle);
            },
            
            toTime: function(){
                var time = new Date();
                var hourAngle = Angle.fromTimeHour(time);
                var milliseconds = this.distance(hourAngle).toMilliseconds();
                return new Date(time.getTime() + milliseconds);
            },
            
            /**
             * 12 hours in 360 degrees
             */
            toMilliseconds: function(){
                return 12 * 60 * 60 * 1000 / 360 * this.angle;
            },
            
            toString: function(){
                return this.get();
            }
        }

        Angle.config = {
            startAngle: 270,
            oneHourAngle: 30,
            oneMinuteAngle: 6,
            oneSecondAngle: 6
        }

        Angle.fromPoint = function(x1, x2, y1, y2){
            x2 = x2 - Math.floor(document.body.clientWidth / 2);
            y2 = y2 - Math.floor(document.body.clientHeight / 2);
        
            var angle = Math.atan2(x1-x2,y1-y2)*(180/Math.PI);
            angle += 90;
            if(angle < 0){
                angle = Math.abs(angle);
            } else {
                angle = 360 - angle;
            }
            return new Angle(angle);
        }
        
        Angle.fromTimeHour = function(time){
            var angle = new Angle(Angle.config.startAngle + Angle.config.oneHourAngle * (time.getHours() + time.getMinutes() / 60 + time.getSeconds() / 3600));
            return new Angle(angle.normalized());
        }
            
        Angle.fromTimeMinute = function(time){
            var angle = new Angle(Angle.config.startAngle + Angle.config.oneMinuteAngle * (time.getMinutes() + time.getSeconds() / 60));
            return new Angle(angle.normalized());
        }
        
        Angle.fromTimeSecond = function(time){
            var angle = new Angle(Angle.config.startAngle + Angle.config.oneSecondAngle * (time.getSeconds() + time.getMilliseconds() / 1000));
            return new Angle(angle.normalized());
        }
        
        /****************************************************/
        
        function Clock(){
            this.xmlns = "http://www.w3.org/2000/svg";
            
            this.markStep = 5;
            
            this.hoursArrow = document.getElementById('hours');
            this.minutesArrow = document.getElementById('minutes');
            this.secondsArrow = document.getElementById('seconds');
            
            this.createMarks();
            
            this.activeMark = null;
            
            var clockface = document.getElementById('clockface');
            this.attachTouchEvents(clockface);
            this.attachMouseEvents(clockface);
            
            this.isMarkReady = false;
            this.stopDelay = 200;//milliseconds
            this.stopTimeout = null;
            
            this.markReadyColor = "#66ff00";
            this.markActiveColor = "orange";
            
            this.activeMarkThreshold = this.markStep * 2;
            
            this.speedTimeBlock = document.getElementById('speedTimeBlock');
            this.speedTime = document.getElementById('speedTime');
            
            this.touchStartAngle = null;
            this.currentAngle = null;
            
            this.moveSpeed = 1/3;
            
            var thisObj = this;
            document.getElementById('clearButton').onclick = function(e){
                e.preventDefault();
                localStorage.clear();
                thisObj.updateMarks();
            }
        }
        
        Clock.prototype = {
            attachTouchEvents: function(element){
                var thisObj = this;
                var isTouchStart = false;
            
                element.ontouchstart = function(e){
                    e.preventDefault();
                    isTouchStart = true;
                    
                    var touch = e.touches[0];
                    thisObj.startHighlightMark(touch.pageX, touch.pageY);
                    thisObj.highlightMark(touch.pageX, touch.pageY);
                }
                
                document.body.ontouchmove = function(e){
                    e.preventDefault();
                    if (isTouchStart){
                        var touch = e.touches[0];
                        thisObj.highlightMark(touch.pageX, touch.pageY);
                    }
                }
                
                document.body.ontouchend = function(){
                    isTouchStart = false;
                    thisObj.stopHighlightMark();
                }
            },
        
            attachMouseEvents: function(element){
                var thisObj = this;
                var isMouseDown = false;
            
                element.onmousedown = function(e){
                    e.preventDefault();
                    isMouseDown = true;

                    thisObj.startHighlightMark(e.pageX, e.pageY);
                    thisObj.highlightMark(e.pageX, e.pageY);
                }
                
                document.body.onmousemove = function(e){
                    e.preventDefault();
                    if (isMouseDown){
                        thisObj.highlightMark(e.pageX, e.pageY);
                    }
                }
                
                document.body.onmouseup = function(){
                    isMouseDown = false;
                    thisObj.stopHighlightMark();
                }
            },
        
            startHighlightMark: function(x, y){
                this.touchStartAngle = Angle.fromPoint(0, x, 0, y);
                this.currentAngle = new Angle(this.touchStartAngle.get());
                this.activeMark = null;
                this.speedTimeBlock.setAttribute('display', 'inline');
            },
        
            highlightMark: function(x, y){
                var thisObj = this;
                
                var angle = Angle.fromPoint(0, x, 0, y);
                var diffAngle = angle.get() - this.currentAngle.normalized();
                if (Math.abs(diffAngle) > 180) {
                    var sign = diffAngle <= 0 ? 1 : -1;
                    diffAngle = (360 - Math.abs(diffAngle)) * sign;
                }
                
                this.currentAngle.add(diffAngle);

                angle.set(this.touchStartAngle.get() + (this.currentAngle.get() - this.touchStartAngle.get()) * this.moveSpeed);
                angle.set(Math.round(angle.get() / this.markStep) * this.markStep + 180);
                angle.normalize();

                var mark = document.getElementById(this.getMarkId(angle.get()));
                if (!mark || mark === this.activeMark) return;
                
                if (this.activeMark){
                    this.toggleMark(this.activeMark, true);
                }
                
                if (this.stopTimeout) clearTimeout(this.stopTimeout);
                
                this.isMarkReady = false;
                this.stopTimeout = setTimeout(function(){
                    thisObj.setMarkReady(mark);
                }, this.stopDelay);
                
                this.toggleMark(mark);
                this.activeMark = mark;
                
                var textTime = this.formatTime(angle.toTime());
                var textNode = document.createTextNode(textTime);
                
                var children = this.speedTime.childNodes;
                while(children.length) {
                    this.speedTime.removeChild(children[0]);
                }
                this.speedTime.appendChild(textNode);
            },
        
            stopHighlightMark: function(){
                if (!this.activeMark) return;
                this.toggleMark(this.activeMark, true);

                if (this.isMarkReady){
                    this.markAction(this.activeMark);
                }

                this.activeMark = null;
                this.speedTimeBlock.setAttribute('display', 'none');
            },
            
            setMarkReady: function(mark){
                this.isMarkReady = true;
            },
        
            toggleMark: function(mark, reset){
                var strokeWidth = !reset ? '12' : '0';
                mark.setAttribute("stroke", this.markActiveColor);
                mark.setAttribute("stroke-width", strokeWidth);
            },
        
            getMarkId: function(id){
                return 'mark_' + id;
            },

            start: function(){
                var thisObj = this;
            
                this.updateTime();
                setInterval(function(){
                    thisObj.updateTime();
                }, 1000);
                
                this.updateMarks();
                setInterval(function(){
                    thisObj.updateMarks();
                }, 60000);
            },
            
            updateTime: function(){
                var time = new Date();
                
                this.hoursArrow.setAttribute('transform', 'rotate('+Angle.fromTimeHour(time).get()+')');
                this.minutesArrow.setAttribute('transform', 'rotate('+Angle.fromTimeMinute(time).get()+')');
                this.secondsArrow.setAttribute('transform', 'rotate('+Angle.fromTimeSecond(time).get()+')');
            },
            
            updateMarks: function(){
                var time = new Date();
                var hourAngle = Angle.fromTimeHour(time);
                
                var testTime = (new Angle(60)).toMilliseconds();
                
                for (var angle = 0; angle < 360; angle += this.markStep){
                    var oAngle = new Angle(angle);
                    var mark = document.getElementById(this.getMarkId(oAngle.get()));
                    if (!mark) continue;
                    
                    var markObj = new Mark(oAngle.get());
                    if (time.getTime() - markObj.time.getTime() > testTime){
                        markObj.checked = false;
                        markObj.save();
                    }
                    
                    var distance = oAngle.distance(hourAngle);
                    
                    mark.setAttribute("fill", this.getFillColor(markObj, distance));
                    mark.setAttribute("fill-opacity", this.getOpacity(distance));
                }
            },

            createMarks: function(){
                var clockmarkslive = document.getElementById('clockmarkslive');
                var thisObj = this;
    
                for (var angle = 0; angle < 360; angle += this.markStep){
                    var oAngle = new Angle(angle);
                    
                    var gRotate = document.createElementNS(this.xmlns, "g");
                    var gTranslate = document.createElementNS(this.xmlns, "g");
                    
                    var mark = document.createElementNS(this.xmlns, "rect");
                    var width = 0, height = 0;
                
                    if (!(oAngle.get() % Angle.config.oneHourAngle)){
                        mark.setAttribute("class", "mark");
                        width = 130;
                        height = 24;
                    } else {
                        mark.setAttribute("class", "smallmark");
                        width = 80;
                        height = 18;
                    }
                    
                    gTranslate.setAttribute('transform', 'translate(480,0)');

                    mark.setAttribute("x", -width);
                    mark.setAttribute("y", -Math.floor(height / 2));
                    mark.setAttribute("width", width);
                    mark.setAttribute("height", height);
                    mark.setAttribute("stroke-width", "0");
                    
                    mark.setAttribute("id", this.getMarkId(oAngle.get()));
                    mark.setAttribute("data-angle", oAngle.get());
                    gRotate.setAttribute("transform", "rotate(" + oAngle.get() + ")");
                    
                    gTranslate.appendChild(mark);
                    gRotate.appendChild(gTranslate);
                    clockmarkslive.appendChild(gRotate);
                }
            },
            
            markAction: function(node){
                var thisObj = this;
                var angle = new Angle(node.getAttribute('data-angle'));
                var markObj = new Mark(angle.get());

                var timeNode = document.getElementById('setTime');
                timeNode.innerHTML = this.formatTime(angle.toTime());

                var textNode = document.getElementById('eventName');
                textNode.value = markObj.title;
                
                var removeButton = document.getElementById('eventButtonRemove');
                removeButton.onclick = function(){
                    thisObj.eventRemoveAction(angle);
                }
                
                var form = document.getElementById('eventForm');
                form.onsubmit = function(){
                    thisObj.eventSubmitAction(angle, textNode.value);
                    return false;
                }
            
                markObj.checked = true;
                markObj.save();
                this.updateMarks();
            
                var prompt = document.getElementById('eventPrompt');
                prompt.setAttribute('display', 'inline');
            },
            
            eventRemoveAction: function(angle){
                this.closeEventPrompt();
                var markObj = new Mark(angle.get());
                markObj.checked = false;
                markObj.save();
                this.updateMarks();
            },
            
            eventSubmitAction: function(angle, title){
                this.closeEventPrompt();
                
                var markObj = new Mark(angle.get());
                markObj.checked = true;
                markObj.title = title;
                markObj.time = angle.toTime();
                markObj.save();
                this.updateMarks();
            },
            
            closeEventPrompt: function(){
                var prompt = document.getElementById('eventPrompt');
                prompt.setAttribute('display', 'none');
            },
            
            formatTime: function(date){
                var hours = date.getHours() + '';
                var minutes = date.getMinutes() + '';
                return (hours.length < 2 ? '0' : '') + hours + ':' + (minutes.length < 2 ? '0' : '') + minutes;
            },
            
            getFillColor: function(markObj, dist){
                var rgbcolor;
                
                if (!markObj.checked){
                    rgbcolor = '#eeeeee';
                } else {
                    if (dist.get() > 0){
                        rgbcolor = dist.get() < 45 ? '#ffff00' : '#00ff00'; 
                    } else {
                        rgbcolor = '#ff0000';
                    }
                }
                
                return rgbcolor;
            },
            
            getOpacity: function(dist){
                var opacityStep = dist.get() > 0 ? 0 : 1 / 55;
                var opacity = 1 - Math.abs(dist.get()) * opacityStep;
                return opacity;
            }
        }
    ]]></script>
</svg>
</body>
</html>